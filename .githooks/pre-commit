#!/bin/bash

# Pre-commit hook to run code formatting checks before committing

echo "Running code format check..."

# Use the existing make lint target (capture full output and exit code)
LINT_OUTPUT=$(make lint 2>&1)
LINT_EXIT_CODE=$?

# Show last 20 lines if there's output
if [ -n "$LINT_OUTPUT" ]; then
    echo "$LINT_OUTPUT" | tail -20
fi

if [ $LINT_EXIT_CODE -ne 0 ]; then
    echo ""
    echo "❌ Code formatting issues detected! Auto-fixing..."
    echo ""

    # Automatically fix formatting issues
    make format
    FORMAT_EXIT_CODE=$?

    if [ $FORMAT_EXIT_CODE -eq 0 ]; then
        echo ""
        echo "✅ Code has been automatically formatted!"
        echo ""
        echo "Please review the changes and stage them:"
        echo "  git add -u"
        echo "  git commit"
        echo ""
    else
        echo ""
        echo "❌ Auto-formatting failed. Please fix manually:"
        echo "  make format"
        echo ""
    fi

    echo "To bypass this check (not recommended), use:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo "✅ Code formatting check passed!"
exit 0